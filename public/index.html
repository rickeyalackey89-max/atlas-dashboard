<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Atlas Dashboard</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 24px; }
      .card { border: 2px solid #000; border-radius: 12px; padding: 16px; max-width: 900px; }
      .title { font-size: 26px; font-weight: 800; margin-bottom: 8px; }
      .row { margin-top: 10px; }
      .label { font-size: 12px; opacity: 0.7; }
      .value { font-size: 16px; font-weight: 700; margin-top: 4px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .box { border: 1px solid #ddd; border-radius: 10px; padding: 10px; background: #fafafa; white-space: pre-wrap; word-break: break-word; }
      .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #000; font-size: 12px; margin-left: 8px; }
      .muted { opacity: 0.7; }
    </style>
  </head>

  <body>
    <div class="card">
      <div class="title">
        Atlas Dashboard
        <span id="status-pill" class="pill">BOOTING</span>
      </div>

      <div class="row">
        <div class="label">What this page is doing</div>
        <div class="value muted">
          Loading <span class="mono">/data/status_latest.json</span> and displaying the results below.
        </div>
      </div>

      <div class="row">
        <div class="label">Fetch URL</div>
        <div class="value mono" id="fetch-url">/data/status_latest.json</div>
      </div>

      <div class="row">
        <div class="label">Fetch result</div>
        <div class="value mono" id="fetch-result">Starting…</div>
      </div>

      <div class="row">
        <div class="label">Last Updated (from JSON key: generated_at)</div>
        <div class="value" id="last-updated">—</div>
      </div>

      <div class="row">
        <div class="label">Parsed JSON (if available)</div>
        <div class="box mono" id="json-box">—</div>
      </div>

      <div class="row">
        <div class="label">Raw response (first 500 chars)</div>
        <div class="box mono" id="raw-box">—</div>
      </div>
    </div>

    <script>
      (async function () {
        const url = '/data/status_latest.json';

        const pill = document.getElementById('status-pill');
        const fetchUrlEl = document.getElementById('fetch-url');
        const fetchResultEl = document.getElementById('fetch-result');
        const lastUpdatedEl = document.getElementById('last-updated');
        const jsonBoxEl = document.getElementById('json-box');
        const rawBoxEl = document.getElementById('raw-box');

        fetchUrlEl.textContent = url + '  (cache-bust: ' + Date.now() + ')';

        try {
          const res = await fetch(url + '?v=' + Date.now(), { cache: 'no-store' });

          fetchResultEl.textContent = `HTTP ${res.status} ${res.statusText}`;
          pill.textContent = res.ok ? 'OK' : 'NOT OK';

          const text = await res.text();
          rawBoxEl.textContent = text.slice(0, 500) || '(empty response)';

          if (!res.ok) {
            lastUpdatedEl.textContent = '—';
            jsonBoxEl.textContent = 'No JSON because fetch was not OK.';
            return;
          }

          // Try parse JSON
          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            pill.textContent = 'BAD JSON';
            fetchResultEl.textContent += ' | JSON parse failed';
            jsonBoxEl.textContent = 'JSON parse error: ' + e.message;
            lastUpdatedEl.textContent = '—';
            return;
          }

          jsonBoxEl.textContent = JSON.stringify(data, null, 2);

          // Pull out generated_at if present
          const raw = (data && data.generated_at) ? data.generated_at : null;
          if (!raw) {
            lastUpdatedEl.textContent = 'Missing "generated_at" in JSON';
            pill.textContent = 'NO generated_at';
            return;
          }

          const dt = new Date(raw);
          if (isNaN(dt.getTime())) {
            lastUpdatedEl.textContent = 'generated_at exists but is not a valid date: ' + String(raw);
            pill.textContent = 'BAD DATE';
            return;
          }

          lastUpdatedEl.textContent = dt.toLocaleString();
          pill.textContent = 'LIVE';
        } catch (e) {
          pill.textContent = 'CRASH';
          fetchResultEl.textContent = 'Fetch crashed: ' + (e && e.message ? e.message : String(e));
          lastUpdatedEl.textContent = '—';
          jsonBoxEl.textContent = '—';
          rawBoxEl.textContent = '—';
        }
      })();
    </script>
  </body>
</html>
