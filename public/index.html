<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Atlas Dashboard</title>
  <style>
    :root{
      --bg1:#f7fafc;
      --bg2:#eef6f1;
      --card:#ffffffcc;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#475569;
      --shadow:0 12px 30px rgba(2,6,23,.08);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, #dbeafe 0%, transparent 60%),
                  radial-gradient(1200px 700px at 80% 20%, #dcfce7 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px 18px 60px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
    h1{margin:0;font-size:28px;letter-spacing:-.02em}
    .sub{margin-top:6px;color:var(--muted);font-size:13.5px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;box-shadow:0 4px 14px rgba(2,6,23,.05);font-size:12px}
    .dot{width:9px;height:9px;border-radius:99px;background:#94a3b8}
    .dot.live{background:#22c55e}
    .dot.aging{background:#f59e0b}
    .dot.stale{background:#ef4444}
    .dot.bad{background:#a855f7}
    .dot.off{background:#64748b}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    button,.btn{
      border:1px solid var(--border);
      background:#ffffffc7;
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      box-shadow:0 10px 24px rgba(2,6,23,.06);
    }
    button:hover,.btn:hover{background:#fff}
    .toggle{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:18px}
    .card{
      grid-column:span 12;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px 12px;
      backdrop-filter: blur(8px);
    }
    .card h2{margin:0 0 10px;font-size:14px;color:#0b1220;letter-spacing:-.01em}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .kv{min-width:170px;flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:14px;background:#fff}
    .k{font-size:12px;color:var(--muted)}
    .v{margin-top:6px;font-weight:650}
    .mono{font-family:var(--mono);font-size:12px;white-space:pre-wrap;word-break:break-word}
    details{border-top:1px dashed rgba(148,163,184,.6);padding-top:12px;margin-top:12px}
    summary{cursor:pointer;color:var(--muted);font-size:13px}
    .slip-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .slip{grid-column:span 12;padding:12px;border:1px solid var(--border);border-radius:14px;background:#fff}
    @media(min-width:800px){
      .slip{grid-column:span 6}
    }
    .slip-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .slip-title{font-weight:750}
    .slip-meta{color:var(--muted);font-size:12px;margin-top:4px}
    .slip-legs{margin-top:10px;font-size:13px;line-height:1.35}
    .slip-legs code{font-family:var(--mono);font-size:12px}
    .slip-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    a.btn{display:inline-flex;align-items:center;text-decoration:none;color:inherit}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <h1>Atlas Dashboard</h1>
          <span class="pill" id="statusPill"><span class="dot off" id="statusDot"></span><span id="statusText">—</span></span>
        </div>
        <div class="sub">Health + “best slip” viewer. Pulls <code class="mono">/data/status_latest.json</code> and the recommended slip JSONs.</div>
      </div>
      <div class="actions">
        <button id="refreshBtn">Refresh</button>
        <button id="copyParsedBtn">Copy parsed</button>
        <button id="copyRawBtn">Copy raw</button>
        <label class="toggle"><input type="checkbox" id="autoRefresh"/> Auto-refresh (30s)</label>
      </div>
    </header>

    <section class="grid">
      <div class="card">
        <h2>Fetch</h2>
        <div class="row">
          <div class="kv">
            <div class="k">Fetch URL</div>
            <div class="v mono" id="fetchUrl">/data/status_latest.json</div>
          </div>
          <div class="kv">
            <div class="k">Result</div>
            <div class="v" id="resultText">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Status</h2>
        <div class="row">
          <div class="kv">
            <div class="k">Last Updated (generated_at)</div>
            <div class="v" id="generatedAt">—</div>
            <div class="k" style="margin-top:10px">Age</div>
            <div class="v" id="ageText">—</div>
          </div>
          <div class="kv">
            <div class="k">Notes</div>
            <div class="v" id="notesText">—</div>
            <div class="k" style="margin-top:10px">Last fetch</div>
            <div class="v" id="lastFetch">—</div>
          </div>
        </div>

        <details open>
          <summary>Best slips (recommended + risky + capper picks)</summary>
          <div class="small" style="margin:10px 0 12px">
            Each card shows the top row from the corresponding JSON (or, for capper picks, top row filtered by leg count).
          </div>
          <div class="slip-grid" id="slipGrid"></div>
        </details>

        <details>
          <summary>Parsed JSON</summary>
          <pre class="mono" id="parsedJson">—</pre>
        </details>
        <details>
          <summary>Raw response</summary>
          <pre class="mono" id="rawJson">—</pre>
        </details>
      </div>
    </section>
  </div>

<script>
(function(){
  const STATUS_URL = "/data/status_latest.json";
  const cacheBust = () => "v=" + Date.now();

  const el = (id) => document.getElementById(id);

  const state = {
    raw: null,
    parsed: null,
    timer: null
  };

  function formatLocal(dtStr){
    if(!dtStr) return "—";
    // supports ISO like 2026-02-06T02:18:29Z or with offset
    const d = new Date(dtStr);
    if(isNaN(d.getTime())) return dtStr;
    return d.toLocaleString();
  }

  function ageFrom(dtStr){
    const d = new Date(dtStr);
    if(isNaN(d.getTime())) return null;
    const ms = Date.now() - d.getTime();
    return ms;
  }

  function formatAge(ms){
    if(ms == null) return "—";
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    return (h>0? (h+"h ") : "") + m + "m";
  }

  function setStatus(level, msg){
    el("statusText").textContent = msg;
    const dot = el("statusDot");
    dot.className = "dot " + level;
  }

  function safeNum(x){
    const n = Number(x);
    return isFinite(n) ? n : null;
  }

  function pct(x){
    const n = safeNum(x);
    if(n == null) return "—";
    return (n*100).toFixed(1) + "%";
  }

  function fmt(x, digits=3){
    const n = safeNum(x);
    if(n == null) return "—";
    return n.toFixed(digits);
  }

  function slipCard({title, href, row, subtitle}){
    const wrap = document.createElement("div");
    wrap.className = "slip";

    const head = document.createElement("div");
    head.className = "slip-head";

    const left = document.createElement("div");
    const t = document.createElement("div");
    t.className = "slip-title";
    t.textContent = title;
    const meta = document.createElement("div");
    meta.className = "slip-meta";
    meta.textContent = subtitle || "";
    left.appendChild(t);
    left.appendChild(meta);

    const right = document.createElement("div");
    right.className = "slip-meta";
    if(row){
      right.innerHTML = `EV <b>${fmt(row.ev_mult,3)}</b> · Hit <b>${pct(row.hit_prob)}</b>`;
    } else {
      right.textContent = "—";
    }

    head.appendChild(left);
    head.appendChild(right);

    const legs = document.createElement("div");
    legs.className = "slip-legs";
    if(row && row.legs){
      legs.innerHTML = `<code>${row.legs}</code>`;
    } else {
      legs.textContent = "Missing / no data";
    }

    const actions = document.createElement("div");
    actions.className = "slip-actions";

    const open = document.createElement("a");
    open.className = "btn";
    open.href = href;
    open.target = "_blank";
    open.rel = "noopener";
    open.textContent = "Open JSON";
    actions.appendChild(open);

    if(row && row.legs){
      const copy = document.createElement("button");
      copy.textContent = "Copy legs";
      copy.addEventListener("click", async () => {
        try { await navigator.clipboard.writeText(row.legs); copy.textContent="Copied"; setTimeout(()=>copy.textContent="Copy legs", 900); } catch(e){}
      });
      actions.appendChild(copy);
    }

    if(row){
      const small = document.createElement("div");
      small.className = "small";
      const frag = fmt(row.avg_fragility,4);
      const tier = row.slip_agreement_tier || "—";
      const tag = row.slip_tag_set || row.slip_tag || "—";
      const start = row.slip_min_start_utc ? formatLocal(row.slip_min_start_utc) : "—";
      small.textContent = `Tier: ${tier} · Fragility: ${frag} · Tag: ${tag} · Earliest: ${start}`;
      actions.appendChild(small);
    }

    wrap.appendChild(head);
    wrap.appendChild(legs);
    wrap.appendChild(actions);
    return wrap;
  }

  async function fetchJson(url){
    const res = await fetch(url, {cache:"no-store"});
    const text = await res.text();
    let parsed = null;
    try { parsed = JSON.parse(text); } catch(e) {}
    return {res, text, parsed};
  }

  async function buildSlips(){
    const grid = el("slipGrid");
    grid.innerHTML = "";

    // Definitions:
    const defs = [
      { key:"rec3", title:"Best 3-Leg (Recommended)", file:"/data/recommended_3leg_latest.json" },
      { key:"rec4", title:"Best 4-Leg (Recommended)", file:"/data/recommended_4leg_latest.json" },
      { key:"rec5", title:"Best 5-Leg (Recommended)", file:"/data/recommended_5leg_latest.json" },

      { key:"r3", title:"Best 3-Leg (Risky)", file:"/data/risky_recommended_3leg_latest.json" },
      { key:"r4", title:"Best 4-Leg (Risky)", file:"/data/risky_recommended_4leg_latest.json" },
      { key:"r5", title:"Best 5-Leg (Risky)", file:"/data/risky_recommended_5leg_latest.json" },

      // Capper picks: come from recommended_latest.json filtered by n_legs
      { key:"cap4", title:"Best 4-Leg (Capper Picks)", file:"/data/recommended_latest.json", filterLegs:4 },
      { key:"cap5", title:"Best 5-Leg (Capper Picks)", file:"/data/recommended_latest.json", filterLegs:5 },
    ];

    for(const d of defs){
      let row = null;
      let subtitle = d.file.replace("/data/","");

      try{
        const {res, parsed} = await fetchJson(d.file + "?" + cacheBust());
        if(res.ok && parsed){
          if(Array.isArray(parsed)){
            row = parsed[0] || null;
            subtitle += ` · rows: ${parsed.length}`;
          } else if(parsed.data && Array.isArray(parsed.data)){
            // capper picks format
            let list = parsed.data;
            if(d.filterLegs){
              list = list.filter(x => Number(x.n_legs) === Number(d.filterLegs));
              subtitle += ` · filtered: ${d.filterLegs}-leg · rows: ${list.length}`;
            } else {
              subtitle += ` · rows: ${list.length}`;
            }
            row = list[0] || null;
          }
        } else {
          subtitle += " · missing";
        }
      } catch(e){
        subtitle += " · error";
      }

      grid.appendChild(slipCard({title:d.title, href:d.file, row, subtitle}));
    }
  }

  async function refresh(){
    el("fetchUrl").textContent = STATUS_URL + " (no-store)";
    el("lastFetch").textContent = new Date().toLocaleString();

    const url = STATUS_URL + "?" + cacheBust();

    try{
      const {res, text, parsed} = await fetchJson(url);
      el("resultText").textContent = "HTTP " + res.status;

      state.raw = text;
      state.parsed = parsed;

      el("rawJson").textContent = text || "—";
      el("parsedJson").textContent = parsed ? JSON.stringify(parsed, null, 2) : "—";

      if(!res.ok){
        setStatus("off", "NOT OK");
        el("notesText").textContent = "Non-200 response.";
        return;
      }
      if(!parsed){
        setStatus("bad", "BAD JSON");
        el("notesText").textContent = "Response could not be parsed as JSON.";
        return;
      }

      const gen = parsed.generated_at || null;
      el("generatedAt").textContent = gen ? formatLocal(gen) : "—";

      const ms = gen ? ageFrom(gen) : null;
      el("ageText").textContent = formatAge(ms);

      let note = (parsed.notes && typeof parsed.notes === "string") ? parsed.notes : "";
      el("notesText").textContent = note || "—";

      // Status thresholds
      const agingMs = 10*60*1000;
      const staleMs = 60*60*1000;

      if(ms == null){
        setStatus("bad", "NO TIME");
      } else if(ms < agingMs){
        setStatus("live", "LIVE");
      } else if(ms < staleMs){
        setStatus("aging", "AGING");
      } else {
        setStatus("stale", "STALE");
      }

      // Build best slips section
      await buildSlips();

    } catch(e){
      setStatus("off", "ERROR");
      el("resultText").textContent = "Fetch error";
      el("notesText").textContent = String(e);
    }
  }

  el("refreshBtn").addEventListener("click", refresh);
  el("copyParsedBtn").addEventListener("click", async () => {
    try{
      if(state.parsed) await navigator.clipboard.writeText(JSON.stringify(state.parsed, null, 2));
    } catch(e){}
  });
  el("copyRawBtn").addEventListener("click", async () => {
    try{
      if(state.raw) await navigator.clipboard.writeText(state.raw);
    } catch(e){}
  });
  el("autoRefresh").addEventListener("change", (ev) => {
    if(ev.target.checked){
      state.timer = setInterval(refresh, 30000);
    } else {
      if(state.timer) clearInterval(state.timer);
      state.timer = null;
    }
  });

  // initial load
  refresh();
})();
</script>
</body>
</html>
