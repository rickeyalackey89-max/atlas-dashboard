<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Atlas Dashboard</title>
  <style>
    :root{
      --bgA:#f7fafc;
      --bgB:#eef6f1;
      --card:#ffffffcc;
      --card2:#ffffffd9;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#475569;
      --shadow:0 12px 30px rgba(2,6,23,.08);
      --shadow2:0 10px 20px rgba(2,6,23,.06);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% 10%, #dbeafe 0%, transparent 60%),
        radial-gradient(1200px 700px at 82% 20%, #dcfce7 0%, transparent 55%),
        linear-gradient(180deg, var(--bgA), var(--bgB));
      min-height:100vh;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:22px 16px 56px}
    header{
      position:sticky; top:0; z-index:10;
      padding:14px 12px;
      margin:-12px -12px 14px;
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.70));
      backdrop-filter: blur(10px);
      border:1px solid rgba(229,231,235,.8);
      box-shadow:0 14px 30px rgba(2,6,23,.06);
    }
    .headRow{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap}
    h1{margin:0;font-size:26px;letter-spacing:-.02em}
    .sub{margin-top:6px;color:var(--muted);font-size:13.5px;line-height:1.35}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;box-shadow:0 4px 14px rgba(2,6,23,.05);
      font-size:12px
    }
    .dot{width:9px;height:9px;border-radius:99px;background:#94a3b8}
    .dot.live{background:#22c55e}
    .dot.aging{background:#f59e0b}
    .dot.stale{background:#ef4444}
    .dot.bad{background:#a855f7}
    .dot.off{background:#64748b}

    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    button,.btn,select{
      border:1px solid var(--border);
      background:#ffffffc7;
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      box-shadow:var(--shadow2);
      transition:transform .06s ease, background .12s ease;
    }
    button:active,.btn:active{transform:translateY(1px)}
    button:hover,.btn:hover,select:hover{background:#fff}
    select{cursor:pointer}
    .toggle{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px;user-select:none}
    .controlLabel{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
    .hintInline{color:var(--muted);font-size:12px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:10px}
    .card{
      grid-column:span 12;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px 12px;
      backdrop-filter: blur(8px);
    }
    .card h2{margin:0 0 10px;font-size:13px;color:#0b1220;letter-spacing:-.01em;text-transform:uppercase}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .kv{
      min-width:170px;flex:1;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .k{font-size:12px;color:var(--muted)}
    .v{margin-top:6px;font-weight:750}
    .mono{font-family:var(--mono);font-size:12px;white-space:pre-wrap;word-break:break-word}

    .divider{height:1px;background:rgba(229,231,235,.9);margin:10px 0 12px;border-radius:999px}
    .sectionTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin:2px 0 12px}
    .sectionTitle .label{font-weight:800}
    .sectionTitle .hint{color:var(--muted);font-size:12px}

    .slip-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}

    .sectionHeader{grid-column:span 12;padding:2px 2px 0;margin-top:6px}
    .sectionHeaderTitle{font-weight:900;font-size:14px;letter-spacing:-.01em;color:#0b1220}
    .sectionHeaderSub{font-size:12px;color:var(--muted);margin-top:2px}

    .groupBar{
      grid-column:span 12;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      box-shadow:0 8px 18px rgba(2,6,23,.04);
      margin-top:2px;
    }
    .groupBar .lhs{display:flex;flex-direction:column;gap:2px}
    .groupBar .title{font-weight:900}
    .groupBar .subline{margin:0;color:var(--muted);font-size:12px}
    .groupBar .rhs{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .smallHint{font-size:12px;color:var(--muted)}

    .slip{
      grid-column:span 12;
      padding:12px 12px 10px;
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--card2);
      box-shadow:0 8px 18px rgba(2,6,23,.05);
    }
    @media(min-width:900px){ .slip{grid-column:span 6} }
    .slip.featured{
      grid-column:span 12;
      background:#fff;
      border:1px solid rgba(59,130,246,.25);
      box-shadow:0 16px 34px rgba(2,6,23,.10);
    }
    .slip-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .slip-title{font-weight:850}
    .slip-meta{color:var(--muted);font-size:12px;margin-top:4px}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{
      font-size:12px;padding:4px 8px;border-radius:999px;
      border:1px solid var(--border);background:#fff;color:#0b1220;
      display:inline-flex;gap:6px;align-items:center;
    }
    .chip b{font-weight:800}
    .slip-legs{margin-top:10px;font-size:13px;line-height:1.38}
    .slip-legs code{font-family:var(--mono);font-size:12px}
    .slip-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
    a.btn{display:inline-flex;align-items:center;text-decoration:none;color:inherit}
    .small{font-size:12px;color:var(--muted);margin-left:auto}

    details{border-top:1px dashed rgba(148,163,184,.6);padding-top:12px;margin-top:12px}
    summary{cursor:pointer;color:var(--muted);font-size:13px}

    .legsWrap{margin-top:10px;overflow-x:auto}
    table.legs-table{width:100%;border-collapse:separate;border-spacing:0}
    .legs-table th,.legs-table td{padding:8px 10px;border-bottom:1px solid rgba(229,231,235,.85);font-size:12px;white-space:nowrap}
    .legs-table th{position:sticky;top:0;background:#fff;color:#0b1220;font-weight:800;text-transform:uppercase;letter-spacing:.02em;font-size:11px}
    .legs-table tr:last-child td{border-bottom:none}
    .legs-table td.mono{font-family:var(--mono);font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:11px}
    .badge .b{font-weight:800}
    .last5{font-family:var(--mono)}

    .listWrap{
      grid-column:span 12;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:10px;
      box-shadow:0 8px 18px rgba(2,6,23,.04);
    }
    .listInner{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
      max-height:420px;
      overflow-y:auto;
      padding-right:4px;
    }
    .listInner .slip{margin:0}
    .listHeadRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin:0 0 10px;
    }
    .listHeadRow .label{font-weight:900}
    .listHeadRow .meta{font-size:12px;color:var(--muted)}
    .dividerTiny{height:1px;background:rgba(229,231,235,.9);margin:8px 0 10px;border-radius:999px}

    .emptyBox{
      grid-column:span 12;
      padding:12px;
      border:1px dashed rgba(148,163,184,.7);
      border-radius:16px;
      background:rgba(255,255,255,.65);
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .emptyBox code{font-family:var(--mono);font-size:12px}

    @media(max-width:520px){
      h1{font-size:22px}
      .slip{padding:12px 12px}
      .chip{font-size:11px}
      .legs-table th,.legs-table td{padding:7px 8px}
      .listInner{max-height:360px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="headRow">
        <div>
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <h1>Atlas Dashboard</h1>
            <span class="pill"><span class="dot off" id="statusDot"></span><span id="statusText">—</span></span>
          </div>
          <div class="sub">
            This page reads three feeds:
            System <code class="mono">/data/recommended_latest.json</code>,
            Windfall <code class="mono">/data/recommended_windfall_latest.json</code>,
            GameScript <code class="mono">/data/recommended_gamescript_latest.json</code>.
            <div class="hintInline">Default view shows <b>ONE</b> best slip per leg-count (3/4/5). Lists are optional.</div>
          </div>
        </div>

        <div class="actions">
          <button id="refreshBtn">Refresh</button>
          <button id="copyParsedBtn">Copy parsed</button>
          <button id="copyRawBtn">Copy raw</button>

          <label class="toggle" title="Show the full scrollable lists under each best slip">
            <input type="checkbox" id="showLists"/>
            Show lists
          </label>

          <label class="controlLabel" id="topNLabel" style="display:none" title="How many slips to show per list (when lists are enabled)">
            Top N
            <select id="topNSelect">
              <option value="10">10</option>
              <option value="15">15</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
            </select>
          </label>

          <label class="toggle"><input type="checkbox" id="autoRefresh"/> Auto-refresh (30s)</label>
        </div>
      </div>
    </header>

    <section class="grid">
      <div class="card">
        <h2>Health</h2>
        <div class="row">
          <div class="kv">
            <div class="k">generated_at</div>
            <div class="v" id="generatedAt">—</div>
            <div class="k" style="margin-top:10px">Age</div>
            <div class="v" id="ageText">—</div>
          </div>
          <div class="kv">
            <div class="k">Fetch</div>
            <div class="v mono" id="fetchUrl">/data/status_latest.json</div>
            <div class="k" style="margin-top:10px">Result · Last fetch</div>
            <div class="v" id="resultText">—</div>
            <div class="k" style="margin-top:10px">Notes</div>
            <div class="v" id="notesText">—</div>
            <div class="k" style="margin-top:10px">Run source</div>
            <div class="v" id="runSource">—</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">
          <div>
            <div class="label">Picks</div>
            <div class="hint">
              “Best” cards are the highest-scored slip in that feed for 3/4/5 legs.
              “Last 5” is rendered from <code class="mono">legs_detail</code> when present.
            </div>
          </div>
          <div class="hint" id="slipHint">—</div>
        </div>

        <div class="slip-grid" id="slipGrid"></div>

        <details>
          <summary>Parsed status JSON</summary>
          <pre class="mono" id="parsedJson">—</pre>
        </details>
        <details>
          <summary>Raw status response</summary>
          <pre class="mono" id="rawJson">—</pre>
        </details>
      </div>
    </section>
  </div>

<script>
function sectionHeader(title, subtitle = "") {
  return `
    <div class="sectionHeader">
      <div class="sectionHeaderTitle">${title}</div>
      ${subtitle ? `<div class="sectionHeaderSub">${subtitle}</div>` : ""}
    </div>
  `;
}

(function(){
  const STATUS_URL = "/data/status_latest.json";
  const cacheBust = () => "v=" + Date.now();

  const el = (id) => document.getElementById(id);
  const state = {
    raw: null,
    parsed: null,
    timer: null,
    ui: {
      showLists: false,
      topN: 25
    },
    feeds: {
      system: { href: "/data/recommended_latest.json", rows: [], ok:false, err:null },
      windfall: { href: "/data/recommended_windfall_latest.json", rows: [], ok:false, err:null },
      gamescript: { href: "/data/recommended_gamescript_latest.json", rows: [], ok:false, err:null }
    }
  };

  function htmlToNode(html){
    const template = document.createElement('template');
    template.innerHTML = String(html).trim();
    return template.content.firstChild;
  }

  function formatLocal(dtStr){
    if(!dtStr) return "—";
    const d = new Date(dtStr);
    if(isNaN(d.getTime())) return dtStr;
    return d.toLocaleString();
  }
  function ageFrom(dtStr){
    const d = new Date(dtStr);
    if(isNaN(d.getTime())) return null;
    return Date.now() - d.getTime();
  }
  function formatAge(ms){
    if(ms == null) return "—";
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    return (h>0? (h+"h ") : "") + m + "m";
  }
  function setStatus(level, msg){
    el("statusText").textContent = msg;
    el("statusDot").className = "dot " + level;
  }
  function safeNum(x){
    const n = Number(x);
    return isFinite(n) ? n : null;
  }
  function pct(x){
    const n = safeNum(x);
    if(n == null) return "—";
    return (n*100).toFixed(1) + "%";
  }
  function fmt(x, digits=3){
    const n = safeNum(x);
    if(n == null) return "—";
    return n.toFixed(digits);
  }

  function escHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function normalizeDir(x){
    const s = String(x ?? "").trim().toUpperCase();
    if(!s) return "—";
    if(s === "0") return "O";
    if(s === "1") return "U";
    if(s === "MORE") return "O";
    if(s === "LESS") return "U";
    if(s === "OVER") return "O";
    if(s === "UNDER") return "U";
    return s;
  }

  function normalizeTier(x){
    const s = String(x||"").trim().toUpperCase();
    return s || "—";
  }

  function renderLast5(val){
    if(val === null || val === undefined) return "—";
    if(typeof val === "number") return `${val}/5`;
    if(typeof val === "string"){
      const t = val.trim();
      if(/^\d\s*\/\s*5$/.test(t)) return t.replace(/\s+/g,"");
      if(/^\d$/.test(t)) return `${t}/5`;
      return t;
    }
    if(typeof val === "object"){
      if(val.hits !== undefined) return `${val.hits}/5`;
      if(val.last5_hits !== undefined) return `${val.last5_hits}/5`;
      if(val.hit_count !== undefined) return `${val.hit_count}/5`;
      if(val.covered_last5 !== undefined) return val.covered_last5 ? "✓" : "—";
    }
    return "—";
  }

  function extractLegRows(row){
    if(!row) return [];

    function parseLegacyLegString(legText){
      const s = String(legText||"").trim();
      if(!s) return null;

      let id = null;
      const mId = s.match(/\[id:\s*(\d+)\s*\]/i);
      if(mId) id = Number(mId[1]);

      let tier = "—";
      const mTier = s.match(/\((STANDARD|GOBLIN|DEMON)\)/i);
      if(mTier) tier = normalizeTier(mTier[1]);

      let dir = "—";
      const mDir = s.match(/\b(OVER|UNDER|MORE|LESS|O|U)\b/i);
      if(mDir) dir = normalizeDir(mDir[1]);

      let line = "—";
      const mLine = s.match(/(-?\d+(?:\.\d+)?)\b/);
      if(mLine) line = mLine[1];

      let stat = "—";
      const mStat = s.match(/\b(OVER|UNDER|MORE|LESS|O|U)\s+([A-Z0-9+\-_/]+)\s+(-?\d+(?:\.\d+)?)/i);
      if(mStat) stat = String(mStat[2]||"—").toUpperCase();
      else {
        const statTokens = ["PTS","REB","AST","FG3M","PR","PA","RA","PRA","BLK","STL","BLKS","STLS","BLKS+STLS","STLS+BLKS","PTS+REB","PTS+AST","REB+AST","PTS+REB+AST"];
        const found = statTokens.find(t => new RegExp(`\\b${t}\\b`, "i").test(s));
        if(found) stat = found.toUpperCase();
      }

      let player = "—";
      const idx = s.search(/\b(OVER|UNDER|MORE|LESS|O|U)\b/i);
      if(idx > 0) player = s.slice(0, idx).replace(/[-–—]+$/,"").trim() || "—";

      return {id, player, stat, dir, line, tier};
    }

    function legacyRowsFromLegsString(legsStr){
      if(!legsStr) return [];
      const parts = String(legsStr).split(/\s*\|\s*/).map(s=>s.trim()).filter(Boolean);
      return parts.map(parseLegacyLegString).filter(Boolean);
    }

    function getLegsDetailArray(){
      const v = row.legs_detail;
      if(!v) return null;
      if(Array.isArray(v)) return v;
      if(typeof v === "string"){
        try{
          const parsed = JSON.parse(v);
          return Array.isArray(parsed) ? parsed : null;
        }catch(e){ return null; }
      }
      return null;
    }

    const legsDetailArr = getLegsDetailArray();
    const legacy = legacyRowsFromLegsString(row.legs);

    if(Array.isArray(legsDetailArr) && legsDetailArr.length){
      const legacyById = new Map();
      for(const l of legacy){
        if(l.id != null) legacyById.set(Number(l.id), l);
      }

      const out = [];
      for(let i=0;i<legsDetailArr.length;i++){
        const x = legsDetailArr[i] || {};
        const id = (x.id != null) ? Number(x.id) : null;

        const baseLegacy = (id != null && legacyById.has(id))
          ? legacyById.get(id)
          : (legacy[i] || {player:"—", stat:"—", dir:"—", line:"—", tier:"—"});

        const last5Val =
          x.last5_hits ?? x.last5 ?? x.last5_hit_count ?? x.last5_hit_rate ??
          x.last5_pattern ?? x.last5_results ?? x.last_5 ?? x.last5Hits ?? x.last_5_hits;

        const player = x.player || x.name || x.display_name || baseLegacy.player || "—";
        const stat   = String(x.stat || x.market || x.prop || baseLegacy.stat || "—").toUpperCase();
        const dir    = normalizeDir(x.direction || x.dir || x.side || baseLegacy.dir);
        const line   = (x.line ?? x.value ?? x.pp_line ?? x.prizepicks_line ?? baseLegacy.line ?? "—");
        const tier   = normalizeTier(x.tier || x.pp_tier || x.price_tier || baseLegacy.tier);

        out.push({player, stat, dir, line, tier, last5: renderLast5(last5Val)});
      }
      return out;
    }

    if(legacy.length){
      return legacy.map(l => ({
        player: l.player || "—",
        stat: l.stat || "—",
        dir: l.dir || "—",
        line: l.line ?? "—",
        tier: l.tier || "—",
        last5: "—"
      }));
    }

    return [];
  }

  function legsTableNode(row){
    const legs = extractLegRows(row);
    if(!legs.length) return null;

    const wrap = document.createElement("div");
    wrap.className = "legsWrap";
    const table = document.createElement("table");
    table.className = "legs-table";

    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th>Player</th>
        <th>Stat</th>
        <th>Dir</th>
        <th>Line</th>
        <th>Tier</th>
        <th>Last 5</th>
      </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    for(const leg of legs){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escHtml(String(leg.player || "—"))}</td>
        <td class="mono">${escHtml(String(leg.stat || "—"))}</td>
        <td class="mono">${escHtml(String(leg.dir || "—"))}</td>
        <td class="mono">${escHtml(String(leg.line ?? "—"))}</td>
        <td><span class="badge"><span class="b">${escHtml(String(leg.tier || "—"))}</span></span></td>
        <td class="last5">${escHtml(String(leg.last5 || "—"))}</td>
      `;
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  function slipCard({title, href, row, subtitle, featured=false}){
    const wrap = document.createElement("div");
    wrap.className = "slip" + (featured ? " featured" : "");

    const head = document.createElement("div");
    head.className = "slip-head";

    const left = document.createElement("div");
    const t = document.createElement("div");
    t.className = "slip-title";
    t.textContent = title;

    const meta = document.createElement("div");
    meta.className = "slip-meta";
    meta.textContent = subtitle || "";
    left.appendChild(t); left.appendChild(meta);

    const right = document.createElement("div");
    right.className = "slip-meta";
    right.innerHTML = row ? `EV <b>${fmt(row.ev_mult,3)}</b><br/>Hit <b>${pct(row.hit_prob)}</b>` : "—";

    head.appendChild(left); head.appendChild(right);

    const chipRow = document.createElement("div");
    chipRow.className = "chipRow";
    if(row){
      const tier = row.slip_agreement_tier || "—";
      const frag = fmt(row.avg_fragility,4);
      const tag = row.slip_tag_set || row.slip_tag || "—";
      const start = row.slip_min_start_utc ? formatLocal(row.slip_min_start_utc) : "—";
      chipRow.innerHTML = `
        <span class="chip">Tier <b>${escHtml(tier)}</b></span>
        <span class="chip">Frag <b>${escHtml(frag)}</b></span>
        <span class="chip">Tag <b>${escHtml(tag)}</b></span>
        <span class="chip">Earliest <b>${escHtml(start)}</b></span>
      `;
    } else {
      chipRow.innerHTML = `<span class="chip">No data</span>`;
    }

    const legs = document.createElement("div");
    legs.className = "slip-legs";
    legs.innerHTML = (row && row.legs) ? `<code>${escHtml(row.legs)}</code>` : "Missing / no data";

    const actions = document.createElement("div");
    actions.className = "slip-actions";

    const open = document.createElement("a");
    open.className = "btn";
    open.href = href;
    open.target = "_blank";
    open.rel = "noopener";
    open.textContent = "Open JSON";
    actions.appendChild(open);

    if(row && row.legs){
      const copy = document.createElement("button");
      copy.textContent = "Copy legs";
      copy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(row.legs);
          copy.textContent="Copied";
          setTimeout(()=>copy.textContent="Copy legs", 900);
        } catch(e){}
      });
      actions.appendChild(copy);
    }

    const small = document.createElement("div");
    small.className = "small";
    small.textContent = subtitle || "";
    actions.appendChild(small);

    wrap.appendChild(head);
    wrap.appendChild(chipRow);
    wrap.appendChild(legs);
    const tbl = legsTableNode(row);
    if(tbl) wrap.appendChild(tbl);
    wrap.appendChild(actions);
    return wrap;
  }

  async function fetchJson(url){
    const res = await fetch(url, {cache:"no-store"});
    const text = await res.text();
    let parsed = null;
    try { parsed = JSON.parse(text); } catch(e) {}
    return {res, text, parsed};
  }

  function toArray(parsed, fallbackKey=null){
    if(Array.isArray(parsed)) return parsed;
    if(parsed && parsed.data && Array.isArray(parsed.data)) return parsed.data;
    if(parsed && fallbackKey && Array.isArray(parsed[fallbackKey])) return parsed[fallbackKey];
    return [];
  }

  function nLegsOf(row){
    return Number(row?.n_legs ?? row?.nlegs ?? row?.legs_n ?? row?.legsCount ?? row?.nLegs ?? row?.nlegs_count ?? NaN);
  }

  function scoreRow(r){
    const ev = Number(r.ev_mult ?? r.ev ?? r.evMult ?? NaN);
    const hp = Number(r.hit_prob ?? r.hitProb ?? NaN);
    if (!Number.isNaN(ev)) return ev;
    if (!Number.isNaN(hp)) return hp;
    return 0;
  }

  function sortRows(rows){
    return rows.slice().sort((a,b) => scoreRow(b) - scoreRow(a));
  }

  async function loadFeedInto(key, url, fallbackKey=null){
    state.feeds[key].ok = false;
    state.feeds[key].err = null;
    state.feeds[key].rows = [];
    try{
      const {res, parsed} = await fetchJson(url + "?" + cacheBust());
      if(!res.ok){
        state.feeds[key].err = `HTTP ${res.status}`;
        return;
      }
      if(!parsed){
        state.feeds[key].err = "BAD JSON";
        return;
      }
      state.feeds[key].rows = toArray(parsed, fallbackKey);
      state.feeds[key].ok = true;
    }catch(e){
      state.feeds[key].err = String(e);
    }
  }

  function groupBarNode({title, subtitle, href, rowsCount, err, ok}){
    const node = document.createElement("div");
    node.className = "groupBar";

    const lhs = document.createElement("div");
    lhs.className = "lhs";
    lhs.innerHTML = `
      <div class="title">${escHtml(title)}</div>
      <div class="subline">${escHtml(subtitle)}</div>
      <div class="smallHint">
        Source: <code class="mono">${escHtml(href)}</code>
        · rows: <b>${rowsCount}</b>
        ${ok ? "" : `· <b>${escHtml(err || "missing")}</b>`}
      </div>
    `;

    const rhs = document.createElement("div");
    rhs.className = "rhs";

    const open = document.createElement("a");
    open.className = "btn";
    open.href = href;
    open.target = "_blank";
    open.rel = "noopener";
    open.textContent = "Open JSON";
    rhs.appendChild(open);

    node.appendChild(lhs);
    node.appendChild(rhs);
    return node;
  }

  function listWrapNode({title, meta, rows, href, maxN}){
    const wrap = document.createElement("div");
    wrap.className = "listWrap";

    const head = document.createElement("div");
    head.className = "listHeadRow";

    const left = document.createElement("div");
    left.innerHTML = `<div class="label">${escHtml(title)}</div><div class="meta">${escHtml(meta||"")}</div>`;

    const right = document.createElement("div");
    right.className = "meta";
    right.innerHTML = `<span class="smallHint">showing <b>${Math.min(maxN, rows.length)}</b> of <b>${rows.length}</b></span>`;

    head.appendChild(left);
    head.appendChild(right);

    const divider = document.createElement("div");
    divider.className = "dividerTiny";

    const inner = document.createElement("div");
    inner.className = "listInner";

    rows.slice(0, maxN).forEach((r, i) => {
      inner.appendChild(slipCard({
        title: `#${i+1}`,
        href,
        row: r,
        subtitle: ""
      }));
    });

    wrap.appendChild(head);
    wrap.appendChild(divider);
    wrap.appendChild(inner);
    return wrap;
  }

  function renderFeed(grid, key, title, subtitle){
    const feed = state.feeds[key];
    const href = feed.href;

    grid.appendChild(groupBarNode({
      title,
      subtitle,
      href,
      rowsCount: (feed.rows || []).length,
      err: feed.err,
      ok: feed.ok
    }));

    if(!feed.ok){
      const box = document.createElement("div");
      box.className = "emptyBox";
      box.innerHTML = `
        <b>${escHtml(title)} is not available.</b><br/>
        This usually means <code>publish-atlas.ps1</code> hasn't pushed fresh <code>public/data</code> yet.<br/>
        Source: <code>${escHtml(href)}</code>${feed.err ? ` · <b>${escHtml(feed.err)}</b>` : ""}
      `;
      grid.appendChild(box);
      return;
    }

    const rows = Array.isArray(feed.rows) ? feed.rows : [];
    if(!rows.length){
      const box = document.createElement("div");
      box.className = "emptyBox";
      box.innerHTML = `
        <b>${escHtml(title)} has 0 rows.</b><br/>
        The feed exists but is empty. Open JSON to confirm: <code>${escHtml(href)}</code>.
      `;
      grid.appendChild(box);
      return;
    }

    // Best only (default): show ONE best slip per 3/4/5
    const legs = [3,4,5];
    for(const n of legs){
      const legRows = sortRows(rows.filter(r => nLegsOf(r) === n));
      const best = legRows[0] || null;

      grid.appendChild(slipCard({
        title: `Best ${n}-Leg (${title})`,
        href,
        row: best,
        subtitle: best ? `${href.replace("/data/","")} · rows: ${rows.length}` : "No data",
        featured: true
      }));

      // Optional lists
      if(state.ui.showLists && legRows.length > 1){
        grid.appendChild(listWrapNode({
          title: `${n}-Leg list (${title})`,
          meta: `Sorted by EV/hit where available · scrollable`,
          rows: legRows,
          href,
          maxN: state.ui.topN
        }));
      }
    }
  }

  async function buildSlips(){
    const grid = el("slipGrid");
    grid.innerHTML = "";

    el("slipHint").textContent =
      state.ui.showLists
        ? `Lists enabled · showing up to Top N = ${state.ui.topN}`
        : "Lists disabled · showing only one best slip per 3/4/5";

    // System
    grid.appendChild(htmlToNode(sectionHeader(
      "Atlas — System Picks",
      "Baseline feed (this must exist)."
    )));
    renderFeed(grid, "system", "System", "Atlas baseline picks.");

    // Windfall
    grid.appendChild(htmlToNode(sectionHeader(
      "Windfall — Tier Mix Picks",
      "Tier composition rules (Goblin/Standard/Demon)."
    )));
    renderFeed(grid, "windfall", "Windfall", "Tier-mix slips with composition rules.");

    // GameScript
    grid.appendChild(htmlToNode(sectionHeader(
      "GameScript — External Picks",
      "External picks scored by Atlas math."
    )));
    renderFeed(grid, "gamescript", "GameScript", "External (AI/human) picks scored by Atlas.");
  }

  async function refresh(){
    el("fetchUrl").textContent = STATUS_URL + " (no-store)";
    const url = STATUS_URL + "?" + cacheBust();

    try{
      const {res, text, parsed} = await fetchJson(url);
      el("resultText").textContent = `HTTP ${res.status} · ${new Date().toLocaleString()}`;

      state.raw = text;
      state.parsed = parsed;

      el("rawJson").textContent = text || "—";
      el("parsedJson").textContent = parsed ? JSON.stringify(parsed, null, 2) : "—";

      if(!res.ok){
        setStatus("off", "NOT OK");
        el("notesText").textContent = "Non-200 response.";
        el("runSource").textContent = "—";
        return;
      }
      if(!parsed){
        setStatus("bad", "BAD JSON");
        el("notesText").textContent = "Response could not be parsed as JSON.";
        el("runSource").textContent = "—";
        return;
      }

      const gen = parsed.generated_at || null;
      el("generatedAt").textContent = gen ? formatLocal(gen) : "—";
      const ms = gen ? ageFrom(gen) : null;
      el("ageText").textContent = formatAge(ms);

      el("notesText").textContent = (parsed.notes && typeof parsed.notes === "string") ? parsed.notes : "—";
      el("runSource").textContent = parsed.run_source || "unknown";

      const agingMs = 10*60*1000;
      const staleMs = 60*60*1000;

      if(ms == null) setStatus("bad", "NO TIME");
      else if(ms < agingMs) setStatus("live", "LIVE");
      else if(ms < staleMs) setStatus("aging", "AGING");
      else setStatus("stale", "STALE");

      // Load feeds (fresh)
      await loadFeedInto("system", state.feeds.system.href, null);
      await loadFeedInto("windfall", state.feeds.windfall.href, "windfall");
      await loadFeedInto("gamescript", state.feeds.gamescript.href, "gamescript");

      await buildSlips();
    } catch(e){
      setStatus("off", "ERROR");
      el("resultText").textContent = "Fetch error";
      el("notesText").textContent = String(e);
      el("runSource").textContent = "—";
    }
  }

  // UI wiring
  el("refreshBtn").addEventListener("click", refresh);

  el("copyParsedBtn").addEventListener("click", async () => {
    try{ if(state.parsed) await navigator.clipboard.writeText(JSON.stringify(state.parsed, null, 2)); } catch(e){}
  });

  el("copyRawBtn").addEventListener("click", async () => {
    try{ if(state.raw) await navigator.clipboard.writeText(state.raw); } catch(e){}
  });

  el("autoRefresh").addEventListener("change", (ev) => {
    if(ev.target.checked) state.timer = setInterval(refresh, 30000);
    else { if(state.timer) clearInterval(state.timer); state.timer = null; }
  });

  function syncTopNVisibility(){
    el("topNLabel").style.display = state.ui.showLists ? "flex" : "none";
  }

  el("showLists").addEventListener("change", (ev) => {
    state.ui.showLists = !!ev.target.checked;
    syncTopNVisibility();
    buildSlips();
  });

  el("topNSelect").addEventListener("change", (ev) => {
    const n = Number(ev.target.value);
    state.ui.topN = Number.isFinite(n) ? n : 25;
    if(state.ui.showLists) buildSlips();
  });

  // Init defaults
  state.ui.showLists = false;
  el("showLists").checked = false;
  state.ui.topN = Number(el("topNSelect").value) || 25;
  syncTopNVisibility();

  refresh();
})();
</script>
</body>
</html>